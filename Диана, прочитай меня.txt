1)код получился очень запутанным и повторяющимся
читать его сложно и за это может попасть
хорошо бы сделать рефакторинг и разбить один большой файл на несколько маленьких,
в которых будет своя логика и все станет понятнее

2)надо пересоздать таблицы, пример-скрин таблиц прикреплю к репозиторию

3)таблицу providers надо создавать через sql-запрос, указав, чтобы поле provider_name было UNIQUE,
иначе таблица providers быстро засорится мусором с одинаковыми названиями производителей и разными id

4)может я не все ошибки и проблемы нашел, так что, пожалуйста, посиди подольше, поиграй с приложением